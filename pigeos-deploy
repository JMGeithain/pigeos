#!/bin/bash
img_dev=/dev/mmcblk0
img_boot=p1
img_root=p2
img_file_in=~/Downloads/2021-05-07-raspios-buster-armhf-lite.img
img_file_out=~/Downloads/$(date -Idate)-pigeos-buster-armhf-beta.img.xz

# write base image
sudo rpi-imager --cli $img_file_in $img_dev
# extend root file system
echo ", +256M" | sudo sfdisk -N 2 $img_dev
sudo fsck.ext4 -f $img_dev$img_root
sudo resize2fs $img_dev$img_root 
# ingest Pi/GEOS files
sudo mount $img_dev$img_root /mnt/pigeos/root/
sudo cp pigeos-setup /mnt/pigeos/root/usr/local/bin
sudo chroot /mnt/pigeos/root/ /bin/bash -ic 'cd /tmp; pigeos-setup setup'
sudo umount $img_dev$img_root
# calculate imgage size
img_last_sector=$(fdisk -l $img_dev | awk 'END{print $4}')
dd if=$img_dev bs=512 count=$img_last_sector status=progress \
  | xz > $img_file_out
